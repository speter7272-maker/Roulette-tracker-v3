<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roulette Trend Tracker • BASE KEYPAD CONFIRMED — ADD TRACKING • v1 • Build: 2025-12-31</title>
  <style>
    :root{color-scheme:dark; --bg:#0b1220; --card:#0f1a2e; --muted:#94a3b8; --txt:#e5e7eb; --accent:#60a5fa; --warn:#fbbf24; --danger:#ef4444; --ok:#34d399; --chip:#111c33; --border:#1f2a44;}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#070b14,#0b1220 40%,#070b14);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}
    h1{font-size:28px;margin:0 0 6px;letter-spacing:.2px}
    .build{margin-top:6px;color:#c7d2fe;font-weight:800;font-size:14px}
    .sub{color:var(--muted);font-size:12px;margin:8px 0 12px;line-height:1.35}
    .card{background:rgba(15,26,46,.88);border:1px solid var(--border);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:8px 10px;font-size:12px;color:var(--muted)}
    .pill b{color:var(--txt)}
    .btn{appearance:none;border:1px solid var(--border);background:var(--chip);color:var(--txt);padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.small{padding:6px 10px;font-size:12px;border-radius:10px}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(96,165,250,.45);background:rgba(96,165,250,.18)}
    .btn.danger{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12)}
    input[type="text"], textarea{width:100%;border-radius:14px;border:1px solid var(--border);background:#0b152b;color:var(--txt);padding:10px}
    textarea{min-height:92px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
    .kbd{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;}
    .key{padding:12px 8px;border-radius:12px;border:1px solid var(--border);background:#0c1730;color:var(--txt);font-weight:900;cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent}
    .key.green{background:rgba(16,185,129,.16);border-color:rgba(16,185,129,.35)}
    .key.zero{background:rgba(245,158,11,.16);border-color:rgba(245,158,11,.35)}
    .key:active{transform:translateY(1px)}
    .stat{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .box{background:#0c1730;border:1px solid var(--border);border-radius:14px;padding:10px}
    .k{color:var(--muted);font-size:11px}
    .v{font-size:16px;font-weight:900;margin-top:2px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .topplays{display:grid;grid-template-columns:1fr;gap:8px}
    .playcard{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);padding:10px;border-radius:12px}
    .playhdr{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);opacity:.9}
    .small{font-size:12px;opacity:.9;line-height:1.25}
    /* modal */
    #expModal{display:none;position:fixed;inset:0;z-index:9999;}
    #expBackdrop{position:absolute;inset:0;background:rgba(0,0,0,.55)}
    #expCard{position:relative;max-width:720px;margin:8vh auto;background:#111827;color:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:16px 16px 12px 16px}
    #expBody{margin:12px 0 0 0;white-space:pre-wrap;word-wrap:break-word;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;line-height:1.35;background:rgba(255,255,255,.06);padding:12px;border-radius:12px;max-height:58vh;overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Roulette Trend Tracker</h1>
    <div class="build">BASE KEYPAD CONFIRMED — ADD TRACKING • v1</div>
    <div class="sub">Build date: <b>2025-12-31</b>. Tap spins on the keypad. Tracks last 10/15/20: columns, dozens, double-streets, red/black, high/low, even/odd, Junko quadrants. Saves on-device.</div>

    <div class="card">
      <div class="row">
        <div class="pill">Window: <b id="winLabel">Last 15</b></div>
        <div class="pill">Spins: <b id="spinCount">0</b></div>
        <div class="pill">Session: <b id="sessionCount">0</b></div>
        <div class="pill">Green: <b id="greenCount">0</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <label class="pill" style="gap:10px; align-items:center; width:100%">
          Casino:
          <input id="casinoInput" type="text" placeholder="e.g., Caesars / Harrah’s Joliet" style="flex:1; min-width:180px" />
        </label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="undoBtn" type="button">Undo</button>
        <button class="btn danger" id="clearBtn" type="button">Clear</button>
        <button class="btn" id="use15Btn" type="button">Use last 15</button>
        <button class="btn" id="use10Btn" type="button">Use last 10</button>
        <button class="btn" id="use20Btn" type="button">Use last 20</button>
        <button class="btn" id="newSessionBtn" type="button">New Session</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="font-weight:900;margin-bottom:8px">Quick input</div>
        <div class="row">
          <input id="manualInput" type="text" placeholder="Type: 0–36 or 00" inputmode="text" />
          <button class="btn primary" id="addManualBtn" type="button">Add</button>
        </div>
        <div class="small" style="margin-top:8px">Tip: On iPhone, the keypad is usually fastest. Manual input is a backup.</div>

        <div class="hr"></div>

        <div id="keypadAnchor" style="font-weight:900;margin-bottom:8px">Tap keypad</div>
        <div class="kbd" id="kbd"></div>
      </div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:8px">Trend + tracking</div>

        <div class="stat">
          <div class="box">
            <div class="k">Recommended play</div>
            <div class="v" id="recommend">Sit out</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="primaryExplainBtn" class="btn small" type="button" style="display:none">Explain</button>
            </div>
            <div class="k" id="reason" style="margin-top:8px">No data yet.</div>
          </div>
          <div class="box">
            <div class="k">Table state</div>
            <div class="v" id="state">—</div>
            <div class="k" id="state2">—</div>
          </div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:900;margin-bottom:8px">Top 3 strategies right now</div>
        <div id="topPlays" class="topplays"></div>

        <div class="hr"></div>

        <div class="stat">
          <div class="box"><div class="k">Columns (C1/C2/C3)</div><div class="v mono" id="cols">0 / 0 / 0</div></div>
          <div class="box"><div class="k">Dozens (D1/D2/D3)</div><div class="v mono" id="doz">0 / 0 / 0</div></div>
          <div class="box"><div class="k">Double Streets (per dozen)</div><div class="v mono" id="ds">D1 — | D2 — | D3 —</div></div>
          <div class="box"><div class="k">Red / Black</div><div class="v mono" id="rb">0 / 0</div></div>
          <div class="box"><div class="k">High / Low</div><div class="v mono" id="hl">0 / 0</div></div>
          <div class="box"><div class="k">Even / Odd</div><div class="v mono" id="eo">0 / 0</div></div>
          <div class="box"><div class="k">Junko quadrants</div><div class="v mono" id="junko">GN 0 | HO 0 | LO 0 | M 0</div></div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:900;margin-bottom:8px">Last 20 (newest first)</div>
        <textarea id="lastList" readonly placeholder="No spins yet."></textarea>

        <div class="hr"></div>

        <div class="row" style="gap:10px;flex-wrap:wrap">
          <button class="btn" id="copyCsvBtn" type="button">Copy CSV</button>
          <button class="btn" id="downloadCsvBtn" type="button">Download CSV</button>
        </div>

        <div class="card" style="margin-top:14px;">
          <div style="font-weight:900">Import session CSV (append to history)</div>
          <div class="small" style="margin-top:6px">Paste CSV with header: <span class="mono">number,casino,date,time,session_id</span>, then tap Import.</div>
          <textarea id="importArea" style="height:120px; margin-top:10px;" placeholder="Paste CSV here..."></textarea>
          <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="importBtn" type="button">Import CSV</button>
            <button class="btn" id="clearImportBtn" type="button">Clear Import Box</button>
          </div>
          <div class="small" id="importStatus" style="margin-top:8px;"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- Explain modal -->
  <div id="expModal">
    <div id="expBackdrop"></div>
    <div id="expCard">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div id="expTitle" style="font-weight:900;font-size:16px;line-height:1.2">Strategy details</div>
        <button id="expClose" class="btn small" type="button" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);">Close</button>
      </div>
      <pre id="expBody"></pre>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const STORAGE_KEY = "roulette_trend_tracker_base_keypad_tracking_v1";
  const ACTIVE_KEY = "roulette_active_strategy_v1";
  const RED = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
  const BLACK = new Set([2,4,6,8,10,11,13,15,17,20,22,24,26,28,29,31,33,35]);

  // Junko quadrants mapping (as previously used)
  const GN = new Set(["00",0,1,2,9,10,13,14,27,28]);
  const HO = new Set([24,25,26,29,30,33,34,35,36]);
  const LO = new Set([3,4,8,11,12,15,16,22,23]);
  const MID= new Set([5,6,7,17,18,19,20,21,31,32]);

  let spins = []; // newest-first: {n,t,s}
  let windowN = 15;
  let sessionId = 1;

  const $ = (id) => document.getElementById(id);

  function numToKey(n) {
    if (n === "00") return "00";
    if (typeof n === "string" && n.trim() === "00") return "00";
    const v = Number(n);
    return Number.isFinite(v) ? v : null;
  }

  function isGreen(n) { return (n === "00" || Number(n) === 0); }
  function isRed(n)   { return (n !== "00" && RED.has(Number(n))); }
  function isBlack(n) { return (n !== "00" && BLACK.has(Number(n))); }
  function isHigh(n)  { return (n !== "00" && Number(n) >= 19); }
  function isLow(n)   { return (n !== "00" && Number(n) >= 1 && Number(n) <= 18); }
  function isEven(n)  { return (n !== "00" && Number(n) !== 0 && Number(n)%2===0); }
  function isOdd(n)   { return (n !== "00" && Number(n)%2===1); }

  function colOf(n) {
    if (n === "00" || n === 0) return null;
    const v = Number(n);
    if (!(v>=1 && v<=36)) return null;
    const r = v % 3;
    return r === 1 ? 1 : (r === 2 ? 2 : 3);
  }
  function dozenOf(n) {
    if (n === "00" || n === 0) return null;
    const v = Number(n);
    if (!(v>=1 && v<=36)) return null;
    return v<=12 ? 1 : (v<=24 ? 2 : 3);
  }
  function streetId(n) {
    if (n === "00" || n === 0) return null;
    const v = Number(n);
    if (!(v>=1 && v<=36)) return null;
    return Math.floor((v-1)/3) + 1; // 1..12
  }
  function junkoBucket(n) {
    const k = (n==="00") ? "00" : Number(n);
    if (GN.has(k)) return "GN";
    if (HO.has(k)) return "HO";
    if (LO.has(k)) return "LO";
    if (MID.has(k)) return "M";
    return null;
  }

  function dsKey(n) {
    if (n === "00" || n === 0) return null;
    const v = Number(n);
    if (!(v>=1 && v<=36)) return null;
    const d = v<=12 ? 1 : (v<=24 ? 2 : 3);
    const base = (d-1)*12;
    const a = base+1, b = base+4, c = base+7;
    if (v>=a && v<=a+5) return {d:d, i:1};
    if (v>=b && v<=b+5) return {d:d, i:2};
    if (v>=c && v<=c+5) return {d:d, i:3};
    return {d:d, i:2};
  }
  function dsCounts(vals) {
    const out = {d1:[0,0,0], d2:[0,0,0], d3:[0,0,0]};
    vals.forEach((n)=>{
      const k = dsKey(n);
      if(!k) return;
      const arr = (k.d===1?out.d1:(k.d===2?out.d2:out.d3));
      arr[k.i-1] += 1;
    });
    return out;
  }

  function counts(vals) {
    const c = {c1:0,c2:0,c3:0,d1:0,d2:0,d3:0,red:0,black:0,high:0,low:0,even:0,odd:0,gn:0,ho:0,lo:0,m:0,green:0};
    vals.forEach((n)=>{
      if(isGreen(n)) c.green++;
      const col = colOf(n); if(col===1)c.c1++; if(col===2)c.c2++; if(col===3)c.c3++;
      const d = dozenOf(n); if(d===1)c.d1++; if(d===2)c.d2++; if(d===3)c.d3++;
      if(isRed(n)) c.red++;
      if(isBlack(n)) c.black++;
      if(isHigh(n)) c.high++;
      if(isLow(n)) c.low++;
      if(isEven(n)) c.even++;
      if(isOdd(n)) c.odd++;
      const jb = junkoBucket(n);
      if(jb==="GN") c.gn++;
      if(jb==="HO") c.ho++;
      if(jb==="LO") c.lo++;
      if(jb==="M") c.m++;
    });
    return c;
  }

  function repeatNumberInfo(vals, lookback) {
    if(vals.length<2) return {flag:false, text:"—"};
    const newest = vals[0];
    const slice = vals.slice(1, Math.min(vals.length, lookback));
    for(let i=0;i<slice.length;i++) {
      if(slice[i]===newest) return {flag:true, text:String(newest)+" repeated within "+(i+1)+" spins"};
    }
    return {flag:false, text:"—"};
  }
  function repeatStreetInfo(vals, lookback) {
    if(vals.length<2) return {flag:false, text:"—"};
    const s0 = streetId(vals[0]);
    if(!s0) return {flag:false, text:"—"};
    for(let i=1;i<Math.min(vals.length, lookback); i++) {
      const si = streetId(vals[i]);
      if(si && si===s0) return {flag:true, text:"Street "+s0+" repeated within "+i+" spins"};
    }
    return {flag:false, text:"—"};
  }

  const STRATEGY_DETAILS = {
    "6 Diamonds (Corner Core)":
`6 Diamonds (Corner Core) — FIXED CORNERS

Corners (fixed 6)
- 1/2/3/5
- 7/8/9/11
- 13/14/15/17
- 19/20/21/23
- 25/26/27/29
- 31/32/33/35

How to bet
- Flat bet 1 unit per corner (your unit size).
- 6 corners total.

Progression (simple, session-safe)
- After a losing spin: +1 unit to ALL 6 corners.
- After a winning spin: −1 unit to ALL 6 corners (minimum 1 unit).

Stop/Reset
- Reset to 1 unit when you’re back near session high, or after any strong recovery.`,

    "Hot Quadrant last-15 (Option A)":
`Hot Quadrant last-15 (Option A)

Trigger
- In last 15 spins, one Junko quadrant has >= 6 hits.

How to bet
- Bet 1 unit on 5 numbers inside the hottest quadrant.
- Optional: if repeats are present, add 2 neighbor numbers inside that quadrant.

Exit / Reset
- If the hot quadrant drops below 6/15, stop and re-evaluate.
- Reset to base on any meaningful recovery (near session high).`,

    "Junko Quadrants (hot/dry)":
`Junko Quadrants (hot/dry)

Quadrants
- GN: 00, 0, 1, 2, 9, 10, 13, 14, 27, 28
- HO: 24,25,26,29,30,33,34,35,36
- LO: 3,4,8,11,12,15,16,22,23
- M: 5,6,7,17,18,19,20,21,31,32

How to use
- If HOT: bet a subset of numbers inside the hottest quadrant (5–7 numbers).
- If DRY: avoid the driest quadrant and play outside it with your preferred structure.

Exit
- Recompute every spin based on last-15 window.`,

    "DS Cash Power":
`DS Cash Power (summary)

Entry
- Based on last-15: in each dozen, identify the hottest double street (6-line).

Bets (base example)
- 3 double streets (one per dozen): 1 unit each.
- Optional corner scaffold per your DSCP variant.

Progression
- Use your DSCP progression rule (step after consecutive losses).
- Reset when near session high.`,

    "Moving Streets (Adjacent Fade)":
`Moving Streets (Adjacent Fade)

Entry
- ONLY when there are NO repeat streets in the last 5 spins (dispersion / choppy).

Rule
- Look at the last 3 streets that hit (convert each number to its street).
- DO NOT bet those 3 streets.
- Instead, bet the adjacent street(s) next to each of those streets.
  Example: if Street 6 hit, adjacent are Streets 5 and 7.
- Merge duplicates; keep total streets reasonable (6–8 streets typical).

Exit
- If street repeats begin (repeat streets flag turns on), stop and switch strategies.`,

    "Sit out":
`Sit out
- Keep logging spins until a repeat or concentration appears.`
  };

  function openExplain(title, body) {
    $("expTitle").textContent = title || "Strategy details";
    $("expBody").textContent = body || "";
    $("expModal").style.display = "block";
  }
  function closeExplain() {
    $("expModal").style.display = "none";
  }
  $("expClose").addEventListener("click", closeExplain);
  $("expBackdrop").addEventListener("click", closeExplain);

  function showExplain(name) {
    // normalize dynamic names (if ever added later)
    let key = name;
    if (key && key.indexOf("Hot Quadrant")===0) key = "Hot Quadrant last-15 (Option A)";
    const body = STRATEGY_DETAILS[key] || STRATEGY_DETAILS[name] || ("No details available for: " + name);
    openExplain(name, body);
  }

  function save() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        spins, windowN, sessionId, casino: $("casinoInput").value || ""
      }));
    } catch(_) {}
  }

  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(Array.isArray(obj.spins)) {
        spins = obj.spins.map(x => {
          if(!x) return null;
          if(typeof x === "string" || typeof x === "number") return {n:numToKey(x), t:Date.now(), s:1};
          return {n:numToKey(x.n), t:Number(x.t)||Date.now(), s:Number(x.s)||1};
        }).filter(x => x && x.n!==null);
      }
      if([10,15,20].includes(obj.windowN)) windowN = obj.windowN;
      if(Number.isFinite(obj.sessionId)) sessionId = Number(obj.sessionId);
      if(typeof obj.casino === "string") $("casinoInput").value = obj.casino;
    } catch(_) {}
  }

  function windowValues() {
    return spins.slice(0, windowN).map(x => x.n);
  }

  function buildKeypad() {
    const kbd = $("kbd");
    const keys = ["00",0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36];
    kbd.innerHTML = "";
    keys.forEach(k => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "key";
      if(k==="00") b.className += " zero";
      if(k===0) b.className += " green";
      b.textContent = String(k);
      // pointer + click (iOS Safari safe)
      b.addEventListener("click", () => addSpin(k), {passive:true});
      b.addEventListener("touchend", (e) => { e.preventDefault(); addSpin(k); }, {passive:false});
      kbd.appendChild(b);
    });
  }

  function addSpin(val) {
    const k = numToKey(val);
    if(k===null) return;
    spins.unshift({ n:k, t:Date.now(), s:sessionId });
    if(spins.length > 5000) spins = spins.slice(0,5000);
    save();
    render();
  }

  function undo() {
    if(spins.length===0) return;
    spins.shift();
    save();
    render();
  }

  function clearAll() {
    if(!confirm("Clear all spins?")) return;
    spins = [];
    sessionId = 1;
    save();
    render();
  }

  function newSession() {
    sessionId += 1;
    save();
    render();
  }

  function csvDate(t) {
    const d = new Date(t);
    const yyyy = String(d.getFullYear());
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function csvTime(t) {
    const d = new Date(t);
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${hh}:${mi}:${ss}`;
  }
  function toCsv() {
    const casino = ($("casinoInput").value||"").replace(/"/g,'""');
    const lines = ["number,casino,date,time,session_id"];
    spins.slice().reverse().forEach(x => {
      const n = (x.n==="00") ? "00" : String(x.n);
      lines.push(`${n},"${casino}",${csvDate(x.t)},${csvTime(x.t)},${x.s}`);
    });
    return lines.join("\n");
  }
  async function copyCsv() {
    const csv = toCsv();
    try {
      await navigator.clipboard.writeText(csv);
      alert("CSV copied.");
    } catch(_) {
      $("lastList").value = csv;
      $("lastList").focus();
      $("lastList").select();
      alert("Clipboard blocked. CSV placed in the box; copy manually.");
    }
  }
  function downloadCsv() {
    const blob = new Blob([toCsv()], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "roulette_spins_ALL.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 4000);
  }

  // CSV import (append + dedupe)
  function parseCsvLine(line) {
    const out = [];
    let i=0, cur="", inQ=false;
    while(i<line.length) {
      const ch = line.charAt(i);
      if(inQ) {
        if(ch === '"') {
          if(i+1<line.length && line.charAt(i+1)==='"') { cur+='"'; i+=2; continue; }
          inQ=false; i++; continue;
        }
        cur+=ch; i++; continue;
      } else {
        if(ch === '"') { inQ=true; i++; continue; }
        if(ch === ',') { out.push(cur); cur=""; i++; continue; }
        cur+=ch; i++; continue;
      }
    }
    out.push(cur);
    return out;
  }
  function parseNumberCell(cell) {
    const t = String(cell||"").trim();
    if(t==="00") return "00";
    const n = Number(t);
    if(!Number.isFinite(n)) return null;
    if(n===0) return 0;
    if(n>=1 && n<=36) return n;
    return null;
  }
  function parseTimestamp(dateStr, timeStr) {
    const ds = String(dateStr||"").trim();
    const ts = String(timeStr||"").trim();
    const iso = ds + "T" + ts;
    const ms = Date.parse(iso);
    if(Number.isFinite(ms)) return ms;
    // fallback
    const p = ds.split("-");
    const q = ts.split(":");
    if(p.length===3 && q.length>=2) {
      const y=Number(p[0]), m=Number(p[1])-1, d=Number(p[2]);
      const hh=Number(q[0]), mi=Number(q[1]), ss=Number(q[2]||0);
      return new Date(y,m,d,hh,mi,ss).getTime();
    }
    return Date.now();
  }
  function importCsvText(text) {
    const raw = String(text||"").trim();
    if(!raw) return {added:0, skipped:0, msg:"Nothing to import."};
    const lines = raw.split(/\r?\n/).filter(x => String(x).trim().length>0);
    if(lines.length < 2) return {added:0, skipped:0, msg:"CSV needs a header + at least 1 row."};

    let startIdx = 0;
    const h = lines[0].toLowerCase();
    if(h.includes("number") && h.includes("session")) startIdx = 1;

    const seen = new Set(spins.map(x => `${String(x.n)}|${String(x.t)}|${String(x.s)}`));
    let added=0, skipped=0;
    let casinoFromFile = null;

    for(let r=startIdx; r<lines.length; r++) {
      const cols = parseCsvLine(lines[r]);
      if(cols.length < 5) { skipped++; continue; }
      const n = parseNumberCell(cols[0]);
      if(n===null) { skipped++; continue; }
      const casino = String(cols[1]||"").trim();
      if(casino && casinoFromFile===null) casinoFromFile = casino;
      const t = parseTimestamp(cols[2], cols[3]);
      let s = Number(String(cols[4]||"").trim());
      if(!Number.isFinite(s)) s = 1;

      const key = `${String(n)}|${String(t)}|${String(s)}`;
      if(seen.has(key)) { skipped++; continue; }
      spins.push({n,t,s});
      seen.add(key);
      added++;
    }

    spins.sort((a,b)=>b.t-a.t);
    if(casinoFromFile && (!$("casinoInput").value || !$("casinoInput").value.trim())) {
      $("casinoInput").value = casinoFromFile;
    }
    save();
    render();
    return {added, skipped, msg:`Imported ${added} spins (skipped ${skipped}).`};
  }

  // Strategy scoring (simple but consistent with earlier intent)
  function scoreStrategies(vals) {
    const w15 = vals.slice(0,15);
    const cts15 = counts(w15);
    const rn = repeatNumberInfo(vals, 5);
    const rs3 = repeatStreetInfo(vals, 3);
    const rs5 = repeatStreetInfo(vals, 5);

    let tableState = "Flat / Choppy";
    if(rn.flag || rs3.flag) tableState = "Repeat-Heavy";
    else {
      const colMax15 = Math.max(cts15.c1, cts15.c2, cts15.c3);
      const dozMax15 = Math.max(cts15.d1, cts15.d2, cts15.d3);
      if(colMax15 >= 7 || dozMax15 >= 7) tableState = "Concentrated";
    }

    const plays = [];
    const add = (name, score, why) => plays.push({name, score, why});

    if(vals.length < 10) {
      add("Sit out", 1, "Log at least 10 spins for trend signals.");
      return {state:tableState, plays:plays.slice(0,3), primary:plays[0]};
    }

    // Repeat-Heavy -> 6D
    if(tableState === "Repeat-Heavy") {
      add("6 Diamonds (Corner Core)", 92, [rn.flag?rn.text:null, rs3.flag?rs3.text:null].filter(Boolean).join(" • "));
    } else {
      add("6 Diamonds (Corner Core)", 70, "Choppy mix: use coverage grinder while waiting for a clearer trend.");
    }

    // Hot quadrant last-15
    const qMax = Math.max(cts15.gn, cts15.ho, cts15.lo, cts15.m);
    if(qMax >= 6) {
      add("Hot Quadrant last-15 (Option A)", 87, `Junko quadrant hot: max=${qMax}/15.`);
    } else if(qMax >= 5) {
      add("Junko Quadrants (hot/dry)", 75, `Junko leaning: max=${qMax}/15 (watch for 6/15 trigger).`);
    }

    // Moving Streets Adjacent Fade when no repeat streets in last-5
    if(!rs5.flag && tableState === "Flat / Choppy") {
      add("Moving Streets (Adjacent Fade)", 64, "No repeat streets in last-5 + choppy table: fade last streets and bet adjacent streets.");
    }

    // DS Cash Power proxy: if DS counts show bias (sum >= 8 in last-15 and any DS>=3)
    const dsc = dsCounts(w15);
    const mx1 = Math.max(...dsc.d1), mx2 = Math.max(...dsc.d2), mx3 = Math.max(...dsc.d3);
    const dsSum = mx1 + mx2 + mx3;
    const dsHas3 = (mx1>=3)||(mx2>=3)||(mx3>=3);
    if(dsSum >= 8 && dsHas3) {
      add("DS Cash Power", 82, `DS bias: best-sum ${dsSum} in last-15 (D1 ${mx1}, D2 ${mx2}, D3 ${mx3}).`);
    }

    plays.sort((a,b)=>b.score-a.score);
    const top = plays.slice(0,3);
    const primary = top[0] || {name:"Sit out", score:1, why:"No clear edge."};
    return {state:tableState, plays:top, primary};
  }

  function render() {
    $("winLabel").textContent = "Last " + windowN;
    $("spinCount").textContent = String(spins.length);
    $("sessionCount").textContent = String(spins.filter(x => x.s===sessionId).length);

    const recent = windowValues();
    $("greenCount").textContent = String(recent.filter(isGreen).length);

    const cts = counts(recent);
    $("cols").textContent = `${cts.c1} / ${cts.c2} / ${cts.c3}`;
    $("doz").textContent  = `${cts.d1} / ${cts.d2} / ${cts.d3}`;

    const dsc = dsCounts(recent);
    $("ds").textContent = `D1 ${dsc.d1[0]}/${dsc.d1[1]}/${dsc.d1[2]} | D2 ${dsc.d2[0]}/${dsc.d2[1]}/${dsc.d2[2]} | D3 ${dsc.d3[0]}/${dsc.d3[1]}/${dsc.d3[2]}`;

    $("rb").textContent   = `${cts.red} / ${cts.black}`;
    $("hl").textContent   = `${cts.high} / ${cts.low}`;
    $("eo").textContent   = `${cts.even} / ${cts.odd}`;
    $("junko").textContent= `GN ${cts.gn} | HO ${cts.ho} | LO ${cts.lo} | M ${cts.m}`;

    $("lastList").value = spins.slice(0,20).map(x => (x.n==="00"?"00":String(x.n))).join(", ");

    const scored = scoreStrategies(recent);
    $("recommend").textContent = scored.primary.name;
    $("reason").textContent = scored.primary.why || "—";
    $("state").textContent = scored.state;
    $("state2").textContent = `Window: last ${windowN} • Session: ${sessionId}`;

    // Top plays cards
    const topPlays = $("topPlays");
    topPlays.innerHTML = "";
    scored.plays.forEach((p, idx) => {
      const div = document.createElement("div");
      div.className = "playcard";
      div.innerHTML = `
        <div class="playhdr">
          <div>
            <div style="font-weight:900">${idx+1}. ${p.name}</div>
            <div class="small">${(p.why||"—").replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
          </div>
          <div class="tag">Score ${p.score}</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn small" data-exp="${p.name}">Explain</button>
        </div>
      `;
      topPlays.appendChild(div);
    });
    [...topPlays.querySelectorAll("button[data-exp]")].forEach(b => {
      b.addEventListener("click", () => showExplain(b.getAttribute("data-exp")));
    });

    // Primary explain button
    const pb = $("primaryExplainBtn");
    if(STRATEGY_DETAILS[scored.primary.name] && scored.primary.name !== "Sit out") {
      pb.style.display = "inline-block";
      pb.onclick = () => showExplain(scored.primary.name);
    } else {
      pb.style.display = "none";
      pb.onclick = null;
    }
  }

  // UI wiring
  $("undoBtn").addEventListener("click", undo);
  $("clearBtn").addEventListener("click", clearAll);
  $("use15Btn").addEventListener("click", () => { windowN=15; save(); render(); });
  $("use10Btn").addEventListener("click", () => { windowN=10; save(); render(); });
  $("use20Btn").addEventListener("click", () => { windowN=20; save(); render(); });
  $("newSessionBtn").addEventListener("click", newSession);

  $("addManualBtn").addEventListener("click", () => {
    const raw = ($("manualInput").value||"").trim();
    if(!raw) return;
    if(raw === "00") addSpin("00");
    else if(/^[0-9]+$/.test(raw)) addSpin(Number(raw));
    $("manualInput").value = "";
  });
  $("manualInput").addEventListener("keydown", (e) => {
    if(e.key === "Enter") {
      e.preventDefault();
      $("addManualBtn").click();
    }
  });

  $("casinoInput").addEventListener("input", save);

  $("copyCsvBtn").addEventListener("click", copyCsv);
  $("downloadCsvBtn").addEventListener("click", downloadCsv);

  $("importBtn").addEventListener("click", () => {
    const res = importCsvText($("importArea").value);
    $("importStatus").textContent = res.msg;
  });
  $("clearImportBtn").addEventListener("click", () => {
    $("importArea").value = "";
    $("importStatus").textContent = "";
  });

  load();
  buildKeypad();
  render();
});
</script>
</body>
</html>
